<script setup lang="ts">
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Separator } from '@/components/ui/separator'
import { ref, watch, nextTick, onMounted, onBeforeUnmount, computed } from 'vue'
import { ChevronLeft, Send } from "lucide-vue-next"
import { useSocketStore } from '@/stores/socket';
import { useRoute } from "vue-router"


// Data chat
const data = ref({
  name: 'Alice',
  avatar: '/avatars/alice.jpg',
  messages: [
    { text: 'Hai, kamu sudah sampai?', time: '14:25', sender: 'other' },
    { text: 'Belum, masih di jalan', time: '14:26', sender: 'me' },
    { text: 'Oke, jam 3 ya?', time: '14:30', sender: 'other' },
  ],
})

const route = useRoute()

// Input pesan
const input = ref('')
const scrollArea = ref(null)
const userId = ref<any>("")
const recipientId = ref<string>("")

const typingTimeout = ref(null)
const isTyping = ref(false)
const showTyping = ref(false)

const socketStore = useSocketStore();

// Fungsi kirim pesan
const sendMessage = () => {
  if (!input.value.trim()) return

  data.value.messages.push({
    text: input.value,
    sender: 'me',
  })

  socketStore.send(input.value);
  input.value = ''
}

// Scroll ke bawah setiap kali messages berubah
watch(
  () => data.value.messages,
  async () => {
    await nextTick()
    scrollToBottom()
  },
  { deep: true }
)

// Fungsi scroll manual
const scrollToBottom = () => {
  if (!scrollArea.value) return
  const viewport = scrollArea.value.$el.querySelector('[data-reka-scroll-area-viewport]')
  if (viewport) {
    viewport.scrollTop = viewport.scrollHeight
  }
}

const isOnline = computed(() => {
  return recipientId.value && socketStore.onlineUsers.includes(recipientId.value);
})

watch(() => socketStore.onlineUsers, (newList) => {
  //console.log('Online users:', Array.from(newList || []))
}, { deep: true })

// Scroll saat pertama kali load
onMounted(() => {
  recipientId.value = route.params.userId;
  socketStore.socket.on('receive-message', (msg) => {
    console.log('Pesan diterima:', msg);
    //socketStore.messages.push(msg); // otomatis update UI
  });
  nextTick(() => scrollToBottom())

  socketStore.socket.on('typing', ({ from, isTyping }) => {
    if (from === recipientId.value) {
      showTyping.value = isTyping
    }
  })

})

onBeforeUnmount(() => {
  if (typingTimeout.value) clearTimeout(typingTimeout.value)
  // Kirim false saat keluar
  socketStore.sendTyping(recipientId.value, false)
})

const handleInput = () => {
  if (!recipientId.value) return

  // Jika input kosong â†’ stop
  if (!input.value.trim()) {
    if (typingTimeout.value) {
      clearTimeout(typingTimeout.value)
      typingTimeout.value = null
    }
    socketStore.sendTyping(recipientId.value, false)
    return
  }
  
  socketStore.sendTyping(recipientId.value, true)

  if (clearTimeout.value) clearTimeout(typingTimeout.value);

  typingTimeout.value = setTimeout(() => {
    socketStore.sendTyping(recipientId.value, false)
  }, 2500)
}

</script>

<template>
  <div class="shadow flex flex-col mx-auto h-dvh bg-gray-50 max-w-[500px]">
    <!-- Header -->
    <header class="bg-white border-b px-4 py-3 flex items-center gap-3">
      <router-link to="/chats">
        <Button variant="outline" size="icon">
          <ChevronLeft class="w-4 h-4" />
        </Button>
      </router-link>
      <Avatar>
        <AvatarImage :src="data.avatar" />
        <AvatarFallback>{{ data.name[0] }}</AvatarFallback>
      </Avatar>
      <div>
        <p class="font-semibold text-sm">{{ data.name }}</p>
        <p class="text-xs text-gray-500">{{ showTyping ? "typing ..." : isOnline ? "Online" : "Offline" }}</p>
      </div>
    </header>

    <!-- Messages -->
    <ScrollArea ref="scrollArea" class="flex-1 p-4 h-0">
      <div class="space-y-4">
        <div
          v-for="(msg, index) in data.messages"
          :key="index"
          :class="['flex', msg.sender === 'me' ? 'justify-end' : 'justify-start']"
        >
          <div
            :class="[
              'max-w-xs px-4 py-2 rounded-2xl text-sm',
              msg.sender === 'me'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-900',
            ]"
          >
            <p>{{ msg.text }}</p>
            <p
              :class="[
                'text-xs mt-1',
                msg.sender === 'me' ? 'text-blue-200' : 'text-gray-500',
              ]"
            >
              {{ msg.time }}
            </p>
          </div>
        </div>
      </div>
    </ScrollArea>

    <Separator />

    <!-- Input -->
    <div class="bg-white p-4 flex gap-2">
      <Input
        v-model="input"
        placeholder="Ketik pesan..."
        @input="handleInput"
        @keydown.enter="sendMessage"
        class="flex-1"
      />
      <Button @click="sendMessage" size="icon">
        <Send class="h-4 w-4" />
      </Button>
    </div>
  </div>
</template>
